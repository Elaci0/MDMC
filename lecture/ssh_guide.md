# SSH Guide

Today, we’ll learn how to connect to the ORFEO cluster using the `ssh` protocol.

## Generating a Key

To generate an SSH key pair, run the following command:

```
$ ssh-keygen -t rsa -b 4096 -C 'your_email@example.com'
```

This will create an RSA key pair and prompt you to choose where to save it. The private key will be saved without an extension, typically as `id_rsa`, and the public key will be saved as `id_rsa.pub`.

You can check the keys you’ve generated by inspecting the `~/.ssh` directory.

## Connecting to the ORFEO Cluster

To connect to the ORFEO cluster, use the following command:

```
$ ssh username@195.14.102.215
```

By default, SSH will use the keys stored in `~/.ssh`. However, you can specify a custom key by using this command:

```
$ ssh -i my_custom_key username@195.14.102.215
```

**Exercise**: Copy your key to a different location, rename it, and use it to connect to the ORFEO cluster.

## Adding a New Public Key for ORFEO Login

If you need to generate a new key pair, log in to the ORFEO cluster and add the new public key to the authorized list.

Navigate to `~/.ssh` and append your public key to the `authorized_keys` file on a new line.

*Exercise*: Generate a new pair, enable it on ORFEO and use it to login. Verify using `-v` flag wich key ssh is really using. 

## Transferring Files

You can transfer files between your local machine and the remote machine using SSH.

To copy a file to the ORFEO cluster:

```
$ touch file_to_copy
$ scp file_to_copy username@195.14.192.215:~
```

**Exercise**: Try copying a file to the cluster, log in to verify the transfer, then reverse the process by copying a file from the cluster to your local machine. Repeat this exercise with a folder.

## Configuring SSH

To avoid typing your username, IP address, and private key path every time, you can configure SSH to automate the connection process. Create an SSH config file like this:

```
$ cat ~/.ssh/config
AddKeysToAgent=yes
host *
  SetEnv TERM=xterm
host orfeo
 Hostname 195.14.102.215
 User your_username
 IdentityFile path_to_your_private_key
```

Now, you can log in to ORFEO simply by typing:

```
$ ssh orfeo
```

**Exercise**: Set up your SSH configuration to use the above format for logging in. Use this syntax to copy files with `scp`. Finally, set up 2 hosts, but changing the private key, and test them. 

## Port Forwarding

If you're running a service on a remote machine (e.g., JupyterLab, web server), you can forward a port from the remote machine to your local machine.

On the remote machine, run:

```
$ git clone git@github.com:Master-Data-Management-and-Curation/Scientific-Programming-Environment.git
$ cd Scientific-Programming-Environment/codes/04-forwarding
$ python3 -m http.server 0
```
Doing that you just started an http server runngin on the login node.

On your local machine, forward the port:

```
$ ssh -L 8000:127.0.0.1:{write here the remote port number} orfeo
```

You can now access the service by opening a browser and going to `http://127.0.0.1:8000/**.

*Hint*: `tmux` could be usefull in this exercise.

## Jump-Box (Jump Host)

Our cluster’s compute nodes can only be accessed via the login node since they are on a private network. To log in to a compute node, with ip address `10.128.2.171` from your local machine, you need to go through the login node. Use the `-J` flag to achieve this:

```
$ ssh username@10.128.2.171 -J orfeo
```

**Exercise**: Try logging in to a compute node without using the jump box.

--- 

## `scp` exercise 

To complete this exercise, we will work with two computational nodes, with IP addresses 10.128.2.171 and 10.128.2.175.

1. **Log in** to the computational node at IP 10.128.2.171 and create a file named `username_file1` in the directory `/local_scratch`.

2. Return to the login node, and use the `scp` command to securely copy the file `username_file1` from the node 10.128.2.171 to the node 10.128.2.175, placing it in the `/local_scratch` directory. Use only one instance of `scp`.

3. **Verify** the file transfer by copying `username_file1` from node 10.128.2.175 to your home directory on the login node.

4. Lastly, copy the file from the login node to your personal laptop.

